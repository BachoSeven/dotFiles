#!/bin/bash

# Dmenu script to use aliases with dmenu_run; orginally by https://github.com/jukil/dmenu-scripts-collection/tree/master/dmenu-recent-aliases
#
# Credits also to ewancoder (https://github.com/ewancoder/dotfiles/blob/master/bin/dm)

cache=$XDG_CACHE_HOME/dmenu_run
freq=$XDG_CACHE_HOME/dmenu_history
aliases=$XDG_CONFIG_HOME/aliasrc
source $aliases

case "$1" in
    remove)
        # To remove a file from history:
        # $ dmenu_aliases remove <name>
        grep -v "$2" $freq > temp && mv temp $freq
    ;;
    *)
    (compgen -a; compgen -c | grep -vxF "$(compgen -a)") | sort | tail -n +10 > $cache

    sorted=$(sort $freq | uniq -c | sort -hr | colrm 1 8)
    cmd=`(echo "$sorted"; cat $cache | grep -vxF "$sorted") | dmenu "$@"`
    if ! [ "$cmd" == "" ] && ! [ "$(grep `echo $cmd | tr -d ':;'` $cache)" == "" ]; then
    echo $cmd | tr -d ':;' >> $freq

	cmdexec=$(alias | grep "`echo $cmd | tr -d ':;'`=" | cut -f2 -d"'" | tr -d "'")
        if [ -z "$cmdexec" ]; then
		cmdexec=`echo $cmd | tr -d ':;'`
        fi

	[[ $cmd == *';'* ]] && cmdexec="st -e $cmdexec"

	[[ $cmd == *':'* ]] && cmdexec="xdotool mousemove - 1 mousemove restore; sudo -Ai '$cmdexec'"

        echo "$cmdexec" | bash
    fi
    ;;
esac
