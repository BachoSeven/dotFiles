#!/bin/sh

# 2020 Francesco Minnocci <ascoli.minnocci@gmail.com>
#
# POSIX compliant script to set images or gif animations as a desktop background,
# supports using pywal to extract a colorscheme for Xresources and (neo)vim.
#
# If given a directory as input, `sbg` will choose a random picture/gif for you.
#
# SLOC: 28
#
# Dependencies:
#	- `hsetroot`
# Optional:
#	- [`gifsicle` + `shantz-xwinwrap-bzr` + custom `gifbg` and `extcol` scripts] for GIFs;
# -	[`pywal` + custom `vimwal` script] for integration with `wal` and with `wal.vim`
#	NOTE:
#	-	I also use a custom `dunstreload` script to automatically reload `dunst`
#		colors for use with `wal`.
#	-	`-w` and `-i` are supposed to be mutually exclusive

# Target location
bgloc="${XDG_DATA_HOME:-$HOME/.local/share/}"/bg

# Cleanup root window
pgrep xwinwrap &>/dev/null &&	killall -q xwinwrap
pgrep xrootgif &>/dev/null &&	killall -q xrootgif

linknotif() {
	input="$1"
	ln -sf "$(readlink -f "$input")" "$bgloc" >/dev/null 2>&1 &&
		notify-send -i "$bgloc" "Wallpaper changed."
}

# Parsing logic
while getopts ":hi:w:mtc" o; do
	case "${o}" in
		h) printf "Usage :\\n'$0'\\n\\t [ -i, -input \"path/to/img\" ]\\n\\t [ -m, -maximize: maximize wallpaper ( default format is \"--zoom\" ) ]\\n\\t [ -t, -tile ]\\n\\t [ -c, -center ]\\n\\t [ -w, -wal \"path/to/img\" \"backend\" : use pywal if installed ]\\n\\t [ -h, -help: Show this message ]\\n" && exit 0 ;;

		i)
			vimwal -x && dunstreload
			[ -f "$2" ] && linknotif "$2"
			[ -d "$2" ] && ln -sf "$( find "$(readlink -f "$2")" -iregex '.*.\(jpg\|jpeg\|png\|gif\)' -type f | shuf -n 1)" "$bgloc" >/dev/null 2>&1 && notify-send -i "$bgloc" "choosing a nice wallpaper for ya..."
			xrdb -load "$XDG_CONFIG_HOME/X11/Xresources" ;;

		w)
			vimwal -w && dunstreload
			if [ -f "$2" ]; then
				linknotif "$2"
			elif [ -n "$2" ]; then
				backend="$2"
				[ -f "$3" ] && linknotif "$3"
			fi
			command -v wal >/dev/null 2>&1 && wal -c && wal --backend "${backend:-wal}" -i "$(readlink -f "$bgloc")" >/dev/null 2>&1 ;;

		m) format="-full" ;;

		t) format="-tile" ;;

		c) format="-center" ;;

		*) printf "Invalid option: -%s\\n" "$OPTARG" && exit 1 ;;
	esac
done

# Use gifview for gifs, or else hsetroot
if [ ! -f ~/.cache/wal/active ]; then
	mime="$( file --dereference --brief --mime-type -- "$bgloc" )"
	if [ "$mime" = "image/gif" ]; then
		setsid -f gifbg "$bgloc" && exit 0
	else
		hsetroot "${format:--cover}" "$bgloc" >/dev/null
	fi
fi
